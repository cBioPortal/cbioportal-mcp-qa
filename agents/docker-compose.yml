version: "3.9"

services:
  # 1. ClickHouse MCP Server (Configured for Cloud)
  mcp-clickhouse:
    image: cbioportal/mcp:latest
    container_name: mcp-clickhouse
    environment:
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_VERIFY=true
      - CLICKHOUSE_MCP_SERVER_TRANSPORT=http
      - CLICKHOUSE_MCP_BIND_HOST=0.0.0.0
      - CLICKHOUSE_MCP_BIND_PORT=8000
    ports:
      - "8000:8000"

  # 2. cBioPortal Navigator MCP Server
  cbioportal-navigator:
    image: ghcr.io/fuzhaoyuan/cbioportal-navigator:latest
    container_name: cbioportal-navigator
    environment:
      - MCP_TRANSPORT=http
      - PORT=8002
#      - CBIOPORTAL_BASE_URL=https://www.cbioportal.org
      - CBIOPORTAL_BASE_URL=https://deploy-preview-5312--cbioportalfrontend.netlify.app
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # 3. MCP Agent Base (Connected to ClickHouse)
  mcp-clickhouse-agent:
    image: ghcr.io/gisetia/mcp-agent-base:sha-a37a241
    container_name: mcp-agent
    env_file:
      - .env
    environment:
      # Use your direct Anthropic API Key here
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Specify the provider and model
      - DEFAULT_MODEL=${DEFAULT_MODEL:-anthropic:claude-sonnet-4-5-20250929}
      - PROVIDER=${PROVIDER:-anthropic}
      - MODEL_ID=${MODEL_ID:-anthropic:claude-sonnet-4-5-20250929}
      # The connection to your MCP server
      - MCP_SERVER_URL=http://mcp-clickhouse:8000/mcp
    ports:
      - "8080:5000"
    volumes:
      - ./cbioportal-mcp-prompt.txt:/app/prompts/system_prompt.txt:ro
    depends_on:
      - mcp-clickhouse

  # 4. MCP Navigator Agent (Connected to cBioPortal Navigator)
  mcp-navigator-agent:
    image: ghcr.io/gisetia/mcp-agent-base:sha-a37a241
    container_name: mcp-navigator-agent
    env_file:
      - .env
    environment:
      # Use your direct Anthropic API Key here
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Specify the provider and model
      - DEFAULT_MODEL=${DEFAULT_MODEL:-anthropic:claude-sonnet-4-5-20250929}
      - PROVIDER=${PROVIDER:-anthropic}
      - MODEL_ID=${MODEL_ID:-anthropic:claude-sonnet-4-5-20250929}
      # The connection to cBioPortal Navigator MCP server
      - MCP_SERVER_URL=http://cbioportal-navigator:8002/mcp
    ports:
      - "8081:5000"
    volumes:
      - ./cbioportal-navigator-prompt.txt:/app/prompts/system_prompt.txt:ro
    depends_on:
      - cbioportal-navigator

  nav-null-agent:
    image: ghcr.io/jim-bo/cbio-agent-null:sha-e2a8289
    ports:
      - "5001:5000"
    env_file:
      - .env
    volumes:
      - ./null-nav-prompt.txt:/app/prompts/system_prompt.txt:ro
    environment:
      # Override if your MCP server is reachable at a different address.
      #DEFAULT_MODEL: ${DEFAULT_MODEL:-anthropic:claude-sonnet-4-5-20250929}
      DEFAULT_TEMPERATURE: ${DEFAULT_TEMPERATURE:-0.0}
      DEFAULT_MAX_OUTPUT_TOKENS: ${DEFAULT_MAX_OUTPUT_TOKENS:-1024}
      DEFAULT_CHUNK_SIZE: ${DEFAULT_CHUNK_SIZE:-1200}
      ENABLE_STEP_STREAMING: ${ENABLE_STEP_STREAMING:-true}
      STREAM_TEXT_LIVE: ${STREAM_TEXT_LIVE:-true}
      STREAM_TOOL_NOTICES_LIVE: ${STREAM_TOOL_NOTICES_LIVE:-true}
      STREAM_TOOL_ARGS_LIVE: ${STREAM_TOOL_ARGS_LIVE:-true}
      STREAM_TOOL_RESPONSES_LIVE: ${STREAM_TOOL_RESPONSES_LIVE:-false}
      INCLUDE_FINAL_TEXT: ${INCLUDE_FINAL_TEXT:-true}
      INCLUDE_TOOL_LOGS_FINAL: ${INCLUDE_TOOL_LOGS_FINAL:-false}
      SYSTEM_PROMPT_FILE: ${SYSTEM_PROMPT_FILE:-}
      SIMULATE: ${SIMULATE:-0}

  qa-null-agent:
    image: ghcr.io/jim-bo/cbio-agent-null:sha-e2a8289
    ports:
      - "5002:5000"
    env_file:
      - .env
    volumes:
      - ./null-qa-prompt.txt:/app/prompts/system_prompt.txt:ro
    environment:
      # Override if your MCP server is reachable at a different address.
      #DEFAULT_MODEL: ${DEFAULT_MODEL:-anthropic:claude-sonnet-4-5-20250929}
      DEFAULT_TEMPERATURE: ${DEFAULT_TEMPERATURE:-0.0}
      DEFAULT_MAX_OUTPUT_TOKENS: ${DEFAULT_MAX_OUTPUT_TOKENS:-1024}
      DEFAULT_CHUNK_SIZE: ${DEFAULT_CHUNK_SIZE:-1200}
      ENABLE_STEP_STREAMING: ${ENABLE_STEP_STREAMING:-true}
      STREAM_TEXT_LIVE: ${STREAM_TEXT_LIVE:-true}
      STREAM_TOOL_NOTICES_LIVE: ${STREAM_TOOL_NOTICES_LIVE:-true}
      STREAM_TOOL_ARGS_LIVE: ${STREAM_TOOL_ARGS_LIVE:-true}
      STREAM_TOOL_RESPONSES_LIVE: ${STREAM_TOOL_RESPONSES_LIVE:-false}
      INCLUDE_FINAL_TEXT: ${INCLUDE_FINAL_TEXT:-true}
      INCLUDE_TOOL_LOGS_FINAL: ${INCLUDE_TOOL_LOGS_FINAL:-false}
      SYSTEM_PROMPT_FILE: ${SYSTEM_PROMPT_FILE:-}
      SIMULATE: ${SIMULATE:-0}
