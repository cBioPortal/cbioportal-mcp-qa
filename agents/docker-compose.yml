version: "3.9"

services:
  # 1. ClickHouse MCP Server (Configured for Cloud)
  mcp-clickhouse:
    image: cbioportal/mcp:latest
    container_name: mcp-clickhouse
    environment:
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE}
      - CLICKHOUSE_VERIFY=true
      - CLICKHOUSE_MCP_SERVER_TRANSPORT=http
      - CLICKHOUSE_MCP_BIND_HOST=0.0.0.0
      - CLICKHOUSE_MCP_BIND_PORT=8000
    ports:
      - "8000:8000"

  # 2. cBioPortal Navigator MCP Server
  cbioportal-navigator:
    image: ghcr.io/fuzhaoyuan/cbioportal-navigator:latest
    container_name: cbioportal-navigator
    environment:
      - MCP_TRANSPORT=http
      - PORT=8002
#      - CBIOPORTAL_BASE_URL=https://www.cbioportal.org
      - CBIOPORTAL_BASE_URL=https://deploy-preview-5312--cbioportalfrontend.netlify.app
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # 3. MCP Agent with tools (connects to cBioPortal MCP server)
  mcp-clickhouse-agent:
    image: inodb/mcp-agent-base:bedrock
    container_name: mcp-agent
    env_file:
      - .env
    environment:
      # AWS Bedrock configuration (alternative to ANTHROPIC_API_KEY)
      - USE_BEDROCK=${USE_BEDROCK:-false}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      # Anthropic API (used when USE_BEDROCK=false)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Model configuration
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-5-20250929}
      - DEFAULT_BEDROCK_MODEL=${DEFAULT_BEDROCK_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      # The connection to your MCP server
      - MCP_SERVER_URL=http://mcp-clickhouse:8000/mcp
      - MOCK_EMPTY_MCP=false
    ports:
      - "8080:5000"
    volumes:
      - ./cbioportal-mcp-prompt.txt:/app/prompts/system_prompt.txt:ro
    depends_on:
      - mcp-clickhouse

  # 4. MCP Navigator Agent (Connected to cBioPortal Navigator)
  mcp-navigator-agent:
    image: inodb/mcp-agent-base:bedrock
    container_name: mcp-navigator-agent
    env_file:
      - .env
    environment:
      # AWS Bedrock configuration (alternative to ANTHROPIC_API_KEY)
      - USE_BEDROCK=${USE_BEDROCK:-false}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      # Anthropic API (used when USE_BEDROCK=false)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Model configuration
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-5-20250929}
      - DEFAULT_BEDROCK_MODEL=${DEFAULT_BEDROCK_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      # The connection to cBioPortal Navigator MCP server
      - MCP_SERVER_URL=http://cbioportal-navigator:8002/mcp
    ports:
      - "8081:5000"
    volumes:
      - ./cbioportal-navigator-prompt.txt:/app/prompts/system_prompt.txt:ro
    depends_on:
      - cbioportal-navigator

  # 5. Navigation null agent (no MCP tools - uses MOCK_EMPTY_MCP)
  nav-null-agent:
    image: inodb/mcp-agent-base:bedrock
    container_name: nav-null-agent
    env_file:
      - .env
    environment:
      # AWS Bedrock configuration
      - USE_BEDROCK=${USE_BEDROCK:-false}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      # Anthropic API (used when USE_BEDROCK=false)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Model configuration
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-5-20250929}
      - DEFAULT_BEDROCK_MODEL=${DEFAULT_BEDROCK_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      - DEFAULT_TEMPERATURE=${DEFAULT_TEMPERATURE:-0.0}
      - DEFAULT_MAX_OUTPUT_TOKENS=${DEFAULT_MAX_OUTPUT_TOKENS:-1024}
      # No MCP tools for null agent
      - MOCK_EMPTY_MCP=true
      - INCLUDE_TOOL_LOGS=false
    ports:
      - "5001:5000"
    volumes:
      - ./null-nav-prompt.txt:/app/prompts/system_prompt.txt:ro

  # 6. QA null agent (no MCP tools - uses MOCK_EMPTY_MCP)
  qa-null-agent:
    image: inodb/mcp-agent-base:bedrock
    container_name: qa-null-agent
    env_file:
      - .env
    environment:
      # AWS Bedrock configuration
      - USE_BEDROCK=${USE_BEDROCK:-false}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      # Anthropic API (used when USE_BEDROCK=false)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Model configuration
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-5-20250929}
      - DEFAULT_BEDROCK_MODEL=${DEFAULT_BEDROCK_MODEL:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      - DEFAULT_TEMPERATURE=${DEFAULT_TEMPERATURE:-0.0}
      - DEFAULT_MAX_OUTPUT_TOKENS=${DEFAULT_MAX_OUTPUT_TOKENS:-1024}
      # No MCP tools for null agent
      - MOCK_EMPTY_MCP=true
      - INCLUDE_TOOL_LOGS=false
    ports:
      - "5002:5000"
    volumes:
      - ./null-qa-prompt.txt:/app/prompts/system_prompt.txt:ro
